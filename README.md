import streamlit as st
import pandas as pd

# --- ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö ---
st.set_page_config(page_title="‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤", page_icon="üéì", layout="centered")

# --- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏¥‡∏ä‡∏≤‡πÅ‡∏•‡∏∞‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Å‡∏¥‡∏ï ---
subjects_data = {
    "‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÅ‡∏ö‡∏ö‡∏ß‡∏¥‡∏®‡∏ß‡∏Å‡∏£‡∏£‡∏°‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏¢‡∏≤‡∏ô 1": 3,
    "‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡∏ó‡∏≤‡∏á‡∏ß‡∏¥‡∏®‡∏ß‡∏Å‡∏£‡∏£‡∏°": 2,
    "‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡∏ß‡∏¥‡∏ä‡∏≤‡∏ä‡∏µ‡∏û‡∏ß‡∏¥‡∏®‡∏ß‡∏Å‡∏£‡∏£‡∏°‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏¢‡∏≤‡∏ô": 3,
    "‡∏ù‡∏∂‡∏Å‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏¢‡∏≤‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô": 2,
    "‡πÅ‡∏Ñ‡∏•‡∏Ñ‡∏π‡∏•‡∏±‡∏™ 2 ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏¥‡∏®‡∏ß‡∏Å‡∏£": 3,
    "‡∏Å‡∏•‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏ß‡∏¥‡∏®‡∏ß‡∏Å‡∏£‡∏£‡∏°": 3,
    "‡∏Å‡∏≤‡∏£‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå": 3
}

# --- ‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏±‡∏ß‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏° ---
st.markdown("<h2 style='text-align: center; color: #d35400;'>‡∏°‡∏´‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ‡∏£‡∏≤‡∏ä‡∏°‡∏á‡∏Ñ‡∏•‡∏≠‡∏µ‡∏™‡∏≤‡∏ô</h2>", unsafe_allow_html=True)
st.markdown("<h4 style='text-align: center;'>üéì ‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÄ‡∏Å‡∏£‡∏î</h4>", unsafe_allow_html=True)
st.divider()

# --- 1. ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤ ---
st.subheader("üìù ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤")
col1, col2 = st.columns(2)
with col1:
    student_id = st.text_input("‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤ *", placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤")
    faculty = st.text_input("‡∏Ñ‡∏ì‡∏∞", placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏ì‡∏∞")
with col2:
    student_name = st.text_input("‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• *", placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•")
    branch = st.text_input("‡∏™‡∏≤‡∏Ç‡∏≤", placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏≤‡∏Ç‡∏≤‡∏ß‡∏¥‡∏ä‡∏≤")
year = st.text_input("‡∏ä‡∏±‡πâ‡∏ô‡∏õ‡∏µ", placeholder="‡πÄ‡∏ä‡πà‡∏ô 1, 2")

st.divider()

# --- 2. ‡∏£‡∏±‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤ ‡πÅ‡∏•‡∏∞ ‡∏Å‡∏≤‡∏£‡∏ñ‡∏≠‡∏ô‡∏ß‡∏¥‡∏ä‡∏≤ (W) ---
st.subheader("üìä ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤ (0-100)")
st.write("üìå *‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ñ‡∏≠‡∏ô‡∏ß‡∏¥‡∏ä‡∏≤ ‡πÉ‡∏´‡πâ‡∏ï‡∏¥‡πä‡∏Å‡∏ó‡∏µ‡πà‡∏Å‡∏•‡πà‡∏≠‡∏á '‡∏ñ‡∏≠‡∏ô‡∏ß‡∏¥‡∏ä‡∏≤ (W)' ‡∏î‡πâ‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏á*")

scores = {}
withdraws = {}

# ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏π‡πà‡∏Å‡∏±‡∏ö‡∏ä‡πà‡∏≠‡∏á‡∏ï‡∏¥‡πä‡∏Å‡∏ñ‡∏≠‡∏ô‡∏ß‡∏¥‡∏ä‡∏≤
for subj, credit in subjects_data.items():
    col1, col2 = st.columns([3, 1]) # ‡πÅ‡∏ö‡πà‡∏á‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡πÉ‡∏´‡πâ‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Å‡∏ß‡πà‡∏≤
    with col1:
        scores[subj] = st.number_input(f"{subj} ({credit} ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Å‡∏¥‡∏ï)", min_value=0.0, max_value=100.0, step=1.0, value=0.0, key=f"score_{subj}")
    with col2:
        st.markdown("<div style='margin-top: 32px;'></div>", unsafe_allow_html=True) # ‡∏à‡∏±‡∏î‡πÉ‡∏´‡πâ‡∏ä‡πà‡∏≠‡∏á‡∏ï‡∏¥‡πä‡∏Å‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏û‡∏≠‡∏î‡∏µ
        withdraws[subj] = st.checkbox("‡∏ñ‡∏≠‡∏ô‡∏ß‡∏¥‡∏ä‡∏≤ (W)", key=f"w_{subj}")

st.write("") # ‡πÄ‡∏ß‡πâ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î

# --- 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏•‡∏∞‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î ---
if st.button("üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô", use_container_width=True, type="primary"):
    
    # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô
    if not student_id or not student_name:
        st.warning("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å '‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤' ‡πÅ‡∏•‡∏∞ '‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•' ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏î‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•")
    else:
        total_credit = 0
        total_grade_point = 0
        has_f = False # ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î F ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        results = []
        
        # ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏Å‡∏£‡∏î
        for subj, credit in subjects_data.items():
            
            # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ß‡∏¥‡∏ä‡∏≤‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏Å‡∏î "‡∏ñ‡∏≠‡∏ô (W)" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            if withdraws[subj]:
                grade = "W"
                status = "‡∏ñ‡∏≠‡∏ô‡∏ß‡∏¥‡∏ä‡∏≤ üõë"
                score_display = "-" # ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ñ‡πâ‡∏≤‡∏ñ‡∏≠‡∏ô
                # ‡πÑ‡∏°‡πà‡∏ô‡∏≥‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Å‡∏¥‡∏ï‡πÑ‡∏õ‡∏ö‡∏ß‡∏Å‡πÉ‡∏ô total_credit (‡πÑ‡∏°‡πà‡πÄ‡∏≠‡∏≤‡πÑ‡∏õ‡∏Ñ‡∏¥‡∏î GPA)
            
            else:
                score = scores[subj]
                
                if score >= 80: grade, point = "A", 4.0
                elif score >= 75: grade, point = "B+", 3.5
                elif score >= 70: grade, point = "B", 3.0
                elif score >= 65: grade, point = "C+", 2.5
                elif score >= 60: grade, point = "C", 2.0
                elif score >= 55: grade, point = "D+", 1.5
                elif score >= 50: grade, point = "D", 1.0
                else: 
                    grade, point = "F", 0.0
                    has_f = True # ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ô‡∏µ‡πâ ‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤‡∏ï‡∏¥‡∏î F
                
                total_credit += credit
                total_grade_point += (point * credit)
                status = "‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô ‚ùå" if grade == "F" else "‡∏ú‡πà‡∏≤‡∏ô ‚úÖ"
                score_display = f"{score:.2f}"
                
            results.append({"‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤": subj, "‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Å‡∏¥‡∏ï": credit, "‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô": score_display, "‡πÄ‡∏Å‡∏£‡∏î": grade, "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞": status})
            
        # ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏¥‡∏î GPA (‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏£‡∏ì‡∏µ‡∏ñ‡∏≠‡∏ô‡∏ó‡∏∏‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤‡∏à‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Å‡∏¥‡∏ï‡πÄ‡∏õ‡πá‡∏ô 0)
        gpa = total_grade_point / total_credit if total_credit > 0 else 0.0
        
        # --- 4. ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå ---
        st.success("‚úÖ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô!")
        
        # ‡πÅ‡∏ö‡πà‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÅ‡∏™‡∏î‡∏á GPA ‡πÅ‡∏•‡∏∞ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏ß‡∏°
        col_res1, col_res2 = st.columns(2)
        with col_res1:
            st.metric(label="‡πÄ‡∏Å‡∏£‡∏î‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏™‡∏∞‡∏™‡∏° (GPA)", value=f"{gpa:.2f}")
        with col_res2:
            if has_f:
                st.metric(label="‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏ß‡∏°", value="‡∏ï‡∏¥‡∏î F ‚ùå")
            else:
                st.metric(label="‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏ß‡∏°", value="‡∏õ‡∏Å‡∏ï‡∏¥ ‚úÖ")
                
        st.progress(gpa / 4.0) # ‡∏´‡∏•‡∏≠‡∏î‡∏û‡∏•‡∏±‡∏á GPA
        
        # ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á
        df_results = pd.DataFrame(results)
        st.table(df_results)
        
        # --- 5. ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î Excel ---
        export_data = [
            ["‡∏°‡∏´‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ‡∏£‡∏≤‡∏ä‡∏°‡∏á‡∏Ñ‡∏•‡∏≠‡∏µ‡∏™‡∏≤‡∏ô", "", "", "", ""],
            ["‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤:", f"'{student_id}", "‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•:", student_name, ""],
            ["‡∏Ñ‡∏ì‡∏∞:", faculty, "‡∏™‡∏≤‡∏Ç‡∏≤:", branch, f"‡∏ä‡∏±‡πâ‡∏ô‡∏õ‡∏µ: {year}"],
            ["", "", "", "", ""],
            ["‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤", "‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Å‡∏¥‡∏ï", "‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô", "‡πÄ‡∏Å‡∏£‡∏î", "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞"]
        ]
        for r in results:
            export_data.append([r["‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤"], r["‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Å‡∏¥‡∏ï"], r["‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô"], r["‡πÄ‡∏Å‡∏£‡∏î"], r["‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞"]])
            
        export_data.append(["", "", "", "", ""]) # ‡πÄ‡∏ß‡πâ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î
        
        # ‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏£‡∏∏‡∏õ‡∏ó‡πâ‡∏≤‡∏¢‡πÑ‡∏ü‡∏•‡πå Excel
        export_data.append(["", "", "", "‡πÄ‡∏Å‡∏£‡∏î‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏™‡∏∞‡∏™‡∏° (GPA)", f"{gpa:.2f}"])
        overall_status = "‡∏ï‡∏¥‡∏î F" if has_f else "‡∏õ‡∏Å‡∏ï‡∏¥"
        export_data.append(["", "", "", "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏ß‡∏°", overall_status])
        
        # ‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡πá‡∏ô CSV
        df_export = pd.DataFrame(export_data)
        csv = df_export.to_csv(index=False, header=False).encode('utf-8-sig')
        
        # ‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î
        st.download_button(
            label="üíæ ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (Excel / CSV)",
            data=csv,
            file_name=f"grade_report_{student_id}.csv",
            mime="text/csv",
            use_container_width=True
        )
